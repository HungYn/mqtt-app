<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT æ™ºæ…§æ§åˆ¶é¢æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --gray: #64748b; }
        body { font-family: system-ui, sans-serif; background: #f8fafc; padding: 20px; display: flex; justify-content: center; }
        .card { width: 100%; max-width: 600px; background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem; margin-top: 0; }
        label { display: block; margin: 1rem 0 0.4rem; font-weight: 600; font-size: 0.85rem; color: #475569; }
        input, select, textarea { width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; box-sizing: border-box; font-size: 0.9rem; }
        
        .id-conn-grid { display: grid; grid-template-columns: 1fr auto; gap: 0.8rem; align-items: end; margin-bottom: 1rem; }
        .config-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0.8rem; align-items: end; }
        .checkbox-container { display: flex; align-items: center; height: 38px; gap: 5px; }
        
        button { cursor: pointer; padding: 0.7rem 1.2rem; border: none; border-radius: 0.4rem; font-weight: 600; color: white; transition: 0.2s; white-space: nowrap; }
        .btn-green { background: var(--success); width: 100%; margin-top: 0.8rem; }
        
        .btn-main-conn { height: 38px; min-width: 100px; }
        .is-connected { background-color: var(--danger); }
        .is-disconnected { background-color: var(--success); }

        .hint-text { font-size: 0.75rem; color: #64748b; margin-top: 0.4rem; line-height: 1.4; background: #f1f5f9; padding: 8px; border-radius: 4px; }

        .log-header { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; }
        .btn-clear { background: var(--gray); font-size: 0.7rem; padding: 0.3rem 0.6rem; }
        #log { background: #0f172a; color: #38bdf8; padding: 1rem; height: 160px; overflow-y: auto; border-radius: 0.4rem; font-family: monospace; font-size: 0.8rem; line-height: 1.4; }
    </style>
</head>
<body>

<div class="card">
    <h2>MQTT æ§åˆ¶ä¸­å¿ƒ</h2>
    
    <div class="id-conn-grid">
        <div style="width: 100%;">
            <label>Client ID (UUID)</label>
            <input type="text" id="client_id" readonly style="background: #f1f5f9;">
        </div>
        <button id="main_conn_btn" class="btn-main-conn is-disconnected" onclick="toggleConnection()">å»ºç«‹é€£ç·š</button>
    </div>
    
    <div class="config-grid">
        <div>
            <label>ç™¼é€ä¸»é¡Œ (Publish Topic)</label>
            <input type="text" id="pub_topic" value="hung/shutdown/off">
        </div>
        <div>
            <label>QoS</label>
            <select id="pub_qos"><option value="0">0</option><option value="1">1</option><option value="2">2</option></select>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="pub_retain">
            <label for="pub_retain" style="margin:0; cursor:pointer;">Retain</label>
        </div>
    </div>

    <div class="config-grid" style="grid-template-columns: 2fr 1fr;">
        <div>
            <label>è¨‚é–±ä¸»é¡Œ (Subscribe Topic)</label>
            <input type="text" id="sub_topic" value="hung/shutdown/on">
        </div>
        <div>
            <label>Port (WSS 8084)</label>
            <input type="text" id="port" value="8084">
        </div>
    </div>

    <label>æŒ‡ä»¤é¸æ“‡</label>
    <select id="mode_select">
        <optgroup label="åƒæ•¸è¨­å®š">
            <option value="action = lock">è¨­å®š Lock</option>
            <option value="action = shutdown">è¨­å®š Shutdown</option>
            <option value="reset">é è¨­è¢«æ§ç«¯åƒæ•¸</option>
        </optgroup>
        <optgroup label="ç«‹å³åŸ·è¡Œ">
            <option value="lock">åŸ·è¡Œ Lock</option>
            <option value="shutdown">åŸ·è¡Œ Shutdown</option>
            <option value="status">é¡¯ç¤ºè¢«æ§ç«¯åƒæ•¸ç‹€æ…‹</option>
        </optgroup>
    </select>
    <button class="btn-green" onclick="sendMode()">é€å‡ºæ¨¡å¼æŒ‡ä»¤</button>

    <label>å…è¨±æ™‚æ®µ (å¯å¤šè¡Œè¼¸å…¥æ¯è¡Œçš„æœ€å¾Œè¦åŠ  ; ): </label>
    <textarea id="periods_text" rows="8" placeholder="å°šæœªå–å¾—æ™‚æ®µè³‡æ–™..."></textarea>
    <div class="hint-text">
        â€» é»æ“Šã€Œé¡¯ç¤ºè¢«æ§ç«¯åƒæ•¸ç‹€æ…‹ã€å¾Œï¼Œæ­¤è™•å°‡è‡ªå‹•æ›´æ–°ã€‚
    </div>
    <button class="btn-green" style="background: #7c3aed" onclick="sendPeriods()">åŒæ­¥æ™‚æ®µ</button>

    <div class="log-header">
        <label style="margin:0">ç³»çµ±æ—¥èªŒ</label>
        <button class="btn-clear" onclick="clearLog()">æ¸…ç©ºæ—¥èªŒ</button>
    </div>
    <div id="log">ç³»çµ±å°±ç·’ï¼Œè«‹å»ºç«‹é€£ç·š...</div>
</div>

<script>
    let mqtt = null;
    const saveKeys = ['pub_topic', 'sub_topic', 'port', 'periods_text', 'pub_qos', 'pub_retain'];

    function addLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function clearLog() {
        document.getElementById('log').innerHTML = '<div>æ—¥èªŒå·²æ¸…ç©º</div>';
    }

    function updateBtnUI(isConnected) {
        const btn = document.getElementById('main_conn_btn');
        if (isConnected) {
            btn.innerText = "ä¸­æ–·é€£ç·š";
            btn.className = "btn-main-conn is-connected";
        } else {
            btn.innerText = "å»ºç«‹é€£ç·š";
            btn.className = "btn-main-conn is-disconnected";
        }
    }

    function toggleConnection() {
        if (mqtt && mqtt.isConnected()) {
            mqtt.disconnect();
            addLog("ğŸ›‘ å·²ä¸­æ–·é€£ç·š");
            updateBtnUI(false);
        } else {
            connectMQTT();
        }
    }

    function save() {
        const data = {};
        saveKeys.forEach(k => {
            const el = document.getElementById(k);
            data[k] = el.type === 'checkbox' ? el.checked : el.value;
        });
        localStorage.setItem('mqtt_final_config_v6', JSON.stringify(data));
    }

    function load() {
        const data = JSON.parse(localStorage.getItem('mqtt_final_config_v6') || '{}');
        const isSecure = window.location.protocol === 'https:';
        saveKeys.forEach(k => {
            const el = document.getElementById(k);
            if (data[k] !== undefined) {
                if (el.type === 'checkbox') el.checked = data[k];
                else el.value = data[k];
            } else if (k === 'port') {
                el.value = isSecure ? "8084" : "8000";
            }
        });
    }

    function connectMQTT() {
        if (mqtt && mqtt.isConnected()) return;
        const cid = "Client-" + self.crypto.randomUUID();
        document.getElementById('client_id').value = cid;
        const port = parseInt(document.getElementById('port').value);
        const isSecure = window.location.protocol === 'https:';
        
        mqtt = new Paho.MQTT.Client("mqttgo.io", port, cid);
        
        mqtt.onMessageArrived = (m) => {
            const payload = m.payloadString;
            addLog(`ğŸ“© æ”¶åˆ° : ${payload}`);

            // --- å„ªåŒ–å¾Œçš„è£åˆ‡èˆ‡æ ¼å¼åŒ–é‚è¼¯ ---
            if (payload.includes("periods")) {
                // 1. æ‰¾åˆ° "periods" é–‹å§‹çš„ä½ç½®
                const startIndex = payload.indexOf("periods");
                // 2. è£åˆ‡æ‰å‰é¢çš„æç¤ºæ–‡å­—
                let coreContent = payload.substring(startIndex);
                // 3. é€²è¡Œæ›è¡Œæ ¼å¼åŒ– (åˆ†è™ŸåŠ ç©ºæ ¼ æ›¿æ›ç‚º åˆ†è™Ÿæ›è¡Œ)
                const formatted = coreContent.replace(/;\s*/g, ';\n').trim();
                
                document.getElementById('periods_text').value = formatted;
                addLog("âœ¨ å·²éæ¿¾é›œè¨Šä¸¦æ›´æ–°æ™‚æ®µæ¸…å–®");
                save(); 
            }
        };

        mqtt.onConnectionLost = (e) => {
            if (e.errorCode !== 0) {
                addLog("âš ï¸ é€£ç·šä¸­æ–·: " + e.errorMessage);
                updateBtnUI(false);
            }
        };

        mqtt.connect({
            useSSL: isSecure,
            timeout: 5,
            onSuccess: () => {
                addLog(`âœ… é€£ç·šæˆåŠŸ (SSL: ${isSecure})`);
                mqtt.subscribe(document.getElementById('sub_topic').value);
                updateBtnUI(true);
            },
            onFailure: (e) => {
                addLog(`âŒ å¤±æ•—: ${e.errorMessage}`);
                updateBtnUI(false);
            }
        });
    }

    function publishMsg(msg) {
        if(!mqtt || !mqtt.isConnected()) return alert("è«‹å…ˆé€£ç·š");
        const message = new Paho.MQTT.Message(msg);
        message.destinationName = document.getElementById('pub_topic').value;
        message.qos = parseInt(document.getElementById('pub_qos').value);
        message.retained = document.getElementById('pub_retain').checked;
        mqtt.send(message);
        addLog(`ğŸ“¤ ç™¼é€: ${msg}`);
    }

    function sendMode() { publishMsg(document.getElementById('mode_select').value); }
    function sendPeriods() { 
        const val = document.getElementById('periods_text').value.trim();
        if(val) publishMsg(val);
        else alert("å…§å®¹ä¸èƒ½ç‚ºç©º");
    }

    window.onload = () => {
        load();
        saveKeys.forEach(k => {
            document.getElementById(k).addEventListener('change', save);
            document.getElementById(k).addEventListener('input', save);
        });
    };
</script>
</body>
</html>
