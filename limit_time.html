<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>MQTTGO è¨­å‚™æ§åˆ¶é¢æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f5; padding: 10px; color: #333; }
        .container { max-width: 800px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin: auto; }
        .header { text-align: center; border-bottom: 2px solid #4CAF50; margin-bottom: 5px; padding-bottom: 10px; }
        .section { margin-bottom: 5px; }
        label { display: block; margin: 12px 0 5px; font-weight: bold; color: #555; }
        input, textarea, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        input:focus { border-color: #4CAF50; outline: none; }
        .btn-group { display: flex; gap: 12px; margin-top: 15px; }
        button { flex: 1; padding: 12px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: bold; transition: 0.2s; }
        .btn-status { background-color: #2196F3; }
        .btn-status:hover { background-color: #1976D2; }
        .btn-reset { background-color: #f44336; }
        .btn-reset:hover { background-color: #d32f2f; }
        .btn-send { background-color: #4CAF50; margin-top: 10px; width: 100%; }
        .btn-send:hover { background-color: #45a049; }
        .btn-conn { background-color: #607D8B; margin-top: 10px; }
        #log { background: #2c3e50; color: #ecf0f1; padding: 15px; height: 180px; overflow-y: auto; font-family: monospace; font-size: 13px; border-radius: 6px; margin-top: 10px; line-height: 1.5; }
        .topic-info { font-size: 12px; color: #888; margin-top: 2px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>MQTT è¨­å‚™æ§åˆ¶ä¸­å¿ƒ</h2>
    </div>
    
    <div class="section">
        <label>MQTT Broker (WebSocket æ¨¡å¼)</label>
        <input type="text" id="host" value="mqttgo.io">
        
        <label>Port (ç€è¦½å™¨å°ˆç”¨ç«¯å£)</label>
        <input type="text" id="port" value="8000">

        <label>Client ID (è‡ªå‹•éš¨æ©Ÿç”Ÿæˆ)</label>
        <input type="text" id="client_id" readonly style="background-color: #f9f9f9;">

        <div class="btn-group">
            <button class="btn-conn" onclick="connectMQTT()">æ‰‹å‹•é‡æ–°é€£æ¥</button>
        </div>
    </div>

    <div class="section" style="background: #f9f9f9; padding: 15px; border-radius: 8px;">
        <label>ç™¼é€ä¸»é¡Œ (Publish Topic)</label>
        <input type="text" id="pub_topic" value="hung2641qwe/shutdown/off">
        
        <label>è¨‚é–±ä¸»é¡Œ (Subscribe Topic)</label>
        <input type="text" id="sub_topic" value="hung2641qwe/shutdown/on">
    </div>

    <div class="section">
        <div class="btn-group">
            <button class="btn-status" onclick="publishMsg('status')">æŒ‰éˆ•1ï¼šè¨­å‚™ç‹€æ…‹</button>
            <button class="btn-reset" onclick="publishMsg('reset')">æŒ‰éˆ•2ï¼šè¨­å‚™é‡è¨­</button>
        </div>
    </div>
    <div class="section">
        <label>é¸æ“‡å‹•ä½œæŒ‡ä»¤</label>
        <select id="mode_select">
            <optgroup label="åƒæ•¸è¨­å®š">
                <option value="action = lock">è¨­å®š Lock (é–å®šæ¨¡å¼)</option>
                <option value="action = shutdown">è¨­å®š Shutdown (é—œæ©Ÿæ¨¡å¼)</option>
            </optgroup>
            <optgroup label="ç«‹å³åŸ·è¡Œ">
                <option value="lock">åŸ·è¡Œ Lock (é›»è…¦é–å®š)</option>
                <option value="shutdown">åŸ·è¡Œ Shutdown (é›»è…¦é—œæ©Ÿ)</option>
            </optgroup>
        </select>
        <button class="btn-send" onclick="sendMode()">é€å‡ºé¸å–æŒ‡ä»¤</button>

        <label>æ›´æ–°å…è¨±æ™‚æ®µ (å¯å¤šè¡Œè¼¸å…¥) action = lock æˆ– shutdown; periods æ˜ŸæœŸä¸€ = 09:00-17:00,19:00-21:00</label>
        <textarea id="periods_text" rows="3" placeholder="periods æ˜ŸæœŸä¸€ = 20:00-21:30&#10;periods æ˜ŸæœŸäºŒ = 20:00-21:30"></textarea>
        <button class="btn-send" onclick="sendPeriods()">åŒæ­¥æ™‚æ®µè³‡æ–™</button>
    </div>

    <h3 style="font-size: 1rem; margin-bottom: 5px;">é€šè¨Šæ—¥èªŒ</h3>
    <div id="log">ç­‰å¾…é€£ç·šä¸­...</div>
</div>

<script>
    let mqtt;
    
    // å®šç¾©éœ€è¦è‡ªå‹•å„²å­˜çš„æ¬„ä½ ID
    const autoSaveFields = ['pub_topic', 'sub_topic', 'periods_text', 'host', 'port'];

    function addLog(msg) {
        const log = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        log.innerHTML += `<div><span style="color: #55efc4">[${time}]</span> ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    // --- æ–°å¢ï¼šå„²å­˜è¨­å®šåˆ°ç€è¦½å™¨ ---
    function saveSettings() {
        const settings = {};
        autoSaveFields.forEach(id => {
            settings[id] = document.getElementById(id).value;
        });
        localStorage.setItem('mqtt_config', JSON.stringify(settings));
    }

    // --- æ–°å¢ï¼šå¾ç€è¦½å™¨è®€å–è¨­å®š ---
    function loadSettings() {
        const savedData = localStorage.getItem('mqtt_config');
        if (savedData) {
            const settings = JSON.parse(savedData);
            autoSaveFields.forEach(id => {
                if (settings[id]) {
                    document.getElementById(id).value = settings[id];
                }
            });
            addLog("å·²å¾ç€è¦½å™¨è¼‰å…¥ä¹‹å‰çš„è¨­å®šç´€éŒ„");
        }
    }

    function connectMQTT() {
        // ä½¿ç”¨ç€è¦½å™¨å…§å»º API ç”¢ç”Ÿéš¨æ©Ÿ UUIDï¼Œä¸¦åŠ ä¸Š "Client-" å‰ç¶´
        const clientId = "Client-" + self.crypto.randomUUID();
        // å°‡ç”¢ç”Ÿçš„ ID é¡¯ç¤ºåœ¨ç•«é¢ä¸Šçš„è¼¸å…¥æ¡†ä¸­ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“ç›®å‰çš„ç·¨è™Ÿ
        document.getElementById('client_id').value = clientId;
        
        const host = document.getElementById('host').value;
        const port = parseInt(document.getElementById('port').value);
        // åˆå§‹åŒ– MQTT å®¢æˆ¶ç«¯
        mqtt = new Paho.MQTT.Client(host, port, clientId);

        mqtt.onMessageArrived = (m) => addLog("ğŸ“© æ”¶åˆ°: " + m.payloadString);
        mqtt.onConnectionLost = (e) => addLog("âš ï¸ é€£ç·šä¸­æ–·: " + e.errorMessage);

        mqtt.connect({
            onSuccess: () => {
                addLog(`âœ… æˆåŠŸé€£ç·šè‡³ ${host}`);
                addLog(`ğŸ†” ID: ${clientId}`);
                mqtt.subscribe(document.getElementById('sub_topic').value);
            },
            onFailure: (e) => addLog("âŒ é€£ç·šå¤±æ•—: " + e.errorMessage)
        });
    }

    function publishMsg(msg) {
        if (!mqtt || !mqtt.isConnected()) return alert("æœªé€£ç·š");
        const message = new Paho.MQTT.Message(msg);
        message.destinationName = document.getElementById('pub_topic').value;
        mqtt.send(message);
        addLog("ğŸ“¤ ç™¼é€: " + msg);
    }

    function sendMode() {
        const mode = document.getElementById('mode_select').value;
        publishMsg(`${mode}`);
    }

    function sendPeriods() {
        const val = document.getElementById('periods_text').value;
        if(val.trim()) publishMsg(val);
    }

    // åˆå§‹åŒ–ç¶²é 
    window.onload = function() {
        // 1. å…ˆè®€å–èˆŠè¨­å®š
        loadSettings();
        
        // 2. ç›£è½æ‰€æœ‰è¼¸å…¥æ¡†ï¼Œä¸€æ—¦å…§å®¹æ”¹è®Šå°±è‡ªå‹•å„²å­˜
        autoSaveFields.forEach(id => {
            document.getElementById(id).addEventListener('input', saveSettings);
        });

        // 3. åŸ·è¡Œé€£ç·š
        connectMQTT();
    };
</script>

</body>
</html>