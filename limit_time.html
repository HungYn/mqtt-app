<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT æ™ºæ…§æ§åˆ¶é¢æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
        }

        body {
            font-family: system-ui, sans-serif;
            background: #f8fafc;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .card {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1rem;
            margin-top: 0;
        }

        label {
            display: block;
            margin: 1rem 0 0.4rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: #475569;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.4rem;
            box-sizing: border-box;
            font-size: 0.9rem;
        }

        /* Client ID èˆ‡æŒ‰éˆ•ä¸¦æ’ */
        .id-conn-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.8rem;
            align-items: end;
            margin-bottom: 1rem;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 0.8rem;
            align-items: end;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            height: 38px;
            gap: 5px;
        }

        button {
            cursor: pointer;
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 0.4rem;
            font-weight: 600;
            color: white;
            transition: 0.2s;
            white-space: nowrap;
        }

        .btn-green {
            background: var(--success);
            width: 100%;
            margin-top: 0.8rem;
        }

        .btn-main-conn {
            height: 38px;
            min-width: 100px;
        }

        .is-connected {
            background-color: var(--danger);
        }

        .is-disconnected {
            background-color: var(--success);
        }

        .hint-text {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.4rem;
            line-height: 1.4;
            background: #f1f5f9;
            padding: 8px;
            border-radius: 4px;
        }

        #log {
            background: #0f172a;
            color: #38bdf8;
            padding: 1rem;
            height: 160px;
            overflow-y: auto;
            border-radius: 0.4rem;
            font-family: monospace;
            font-size: 0.8rem;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body>

    <div class="card">
        <h2>MQTT æ§åˆ¶ä¸­å¿ƒ</h2>

        <div class="id-conn-grid">
            <div style="width: 100%;">
                <label>Client ID (UUID)</label>
                <input type="text" id="client_id" readonly style="background: #f1f5f9;">
            </div>
            <button id="main_conn_btn" class="btn-main-conn is-disconnected" onclick="toggleConnection()">å»ºç«‹é€£ç·š</button>
        </div>

        <div class="config-grid">
            <div>
                <label>ç™¼é€ä¸»é¡Œ (Publish Topic)</label>
                <input type="text" id="pub_topic" value="hung2641qwe/shutdown/off">
            </div>
            <div>
                <label>QoS</label>
                <select id="pub_qos"><option value="0">0</option><option value="1">1</option><option value="2">2</option></select>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="pub_retain">
                <label for="pub_retain" style="margin:0; cursor:pointer;">Retain</label>
            </div>
        </div>

        <div class="config-grid" style="grid-template-columns: 2fr 1fr;">
            <div>
                <label>è¨‚é–±ä¸»é¡Œ (Subscribe Topic)</label>
                <input type="text" id="sub_topic" value="hung2641qwe/shutdown/on">
            </div>
            <div>
                <label>Port (WSS 8084)htt(8000)</label>
                <input type="text" id="port" value="8084">
            </div>
        </div>

        <label>æŒ‡ä»¤é¸æ“‡</label>
        <select id="mode_select">
            <optgroup label="åƒæ•¸è¨­å®š">
                <option value="action = lock">è¨­å®š Lock</option>
                <option value="action = shutdown">è¨­å®š Shutdown</option>
                <option value="status">é è¨­è¢«æ§ç«¯åƒæ•¸</option>
            </optgroup>
            <optgroup label="ç«‹å³åŸ·è¡Œ">
                <option value="lock">åŸ·è¡Œ Lock</option>
                <option value="shutdown">åŸ·è¡Œ Shutdown</option>
                <option value="reset">é¡¯ç¤ºè¢«æ§ç«¯åƒæ•¸ç‹€æ…‹</option>
            </optgroup>
        </select>
        <button class="btn-green" onclick="sendMode()">é€å‡ºæ¨¡å¼æŒ‡ä»¤</button>

        <label>å…è¨±æ™‚æ®µ (å¯å¤šè¡Œè¼¸å…¥æ¯è¡Œçš„æœ€å¾Œè¦åŠ  ; ): </label>
        <textarea id="periods_text" rows="4" placeholder="periods æ˜ŸæœŸä¸€ = 09:00-17:00;"></textarea>
        <div class="hint-text">
            ç¯„ä¾‹ï¼š<br>
            periods æ˜ŸæœŸä¸€ = 09:00-17:00,19:00-21:00;<br>
            periods æ˜ŸæœŸäºŒ = 19:00-21:00;
        </div>
        <button class="btn-green" style="background: #7c3aed" onclick="sendPeriods()">åŒæ­¥æ™‚æ®µ</button>

        <div id="log">ç³»çµ±å°±ç·’ï¼Œè«‹å»ºç«‹é€£ç·š...</div>
    </div>

    <script>
        let mqtt;
        const saveKeys = ['pub_topic', 'sub_topic', 'port', 'periods_text', 'pub_qos', 'pub_retain'];

        function addLog(msg) {
            const log = document.getElementById('log');
            log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function updateBtnUI(isConnected) {
            const btn = document.getElementById('main_conn_btn');
            if (isConnected) {
                btn.innerText = "ä¸­æ–·é€£ç·š";
                btn.classList.replace('is-disconnected', 'is-connected');
            } else {
                btn.innerText = "å»ºç«‹é€£ç·š";
                btn.classList.replace('is-connected', 'is-disconnected');
            }
        }

        function toggleConnection() {
            if (mqtt && mqtt.isConnected()) {
                mqtt.disconnect();
                addLog("ğŸ›‘ å·²ä¸­æ–·é€£ç·š");
                updateBtnUI(false);
            } else {
                connectMQTT();
            }
        }

        function save() {
            const data = {};
            saveKeys.forEach(k => {
                const el = document.getElementById(k);
                data[k] = el.type === 'checkbox' ? el.checked : el.value;
            });
            localStorage.setItem('mqtt_final_config_v2', JSON.stringify(data));
        }

        function load() {
            const data = JSON.parse(localStorage.getItem('mqtt_final_config_v2') || '{}');
            const isSecure = window.location.protocol === 'https:';
            saveKeys.forEach(k => {
                const el = document.getElementById(k);
                if (data[k] !== undefined) {
                    if (el.type === 'checkbox') el.checked = data[k];
                    else el.value = data[k];
                } else if (k === 'port') {
                    el.value = isSecure ? "8084" : "8000";
                }
            });
        }

        function connectMQTT() {
            const cid = "Client-" + self.crypto.randomUUID();
            document.getElementById('client_id').value = cid;
            const port = parseInt(document.getElementById('port').value);
            const isSecure = window.location.protocol === 'https:';

            mqtt = new Paho.MQTT.Client("mqttgo.io", port, cid);
            mqtt.onMessageArrived = (m) => addLog(`ğŸ“© æ”¶åˆ° (${m.destinationName}): ${m.payloadString}`);
            mqtt.onConnectionLost = (e) => {
                addLog("âš ï¸ é€£ç·šä¸­æ–·: " + e.errorMessage);
                updateBtnUI(false);
            };

            mqtt.connect({
                useSSL: isSecure,
                timeout: 5,
                onSuccess: () => {
                    addLog(`âœ… é€£ç·šæˆåŠŸ (SSL: ${isSecure})`);
                    mqtt.subscribe(document.getElementById('sub_topic').value);
                    updateBtnUI(true);
                },
                onFailure: (e) => {
                    addLog(`âŒ é€£ç·šå¤±æ•—: ${e.errorMessage}`);
                    updateBtnUI(false);
                }
            });
        }

        function publishMsg(msg) {
            if (!mqtt || !mqtt.isConnected()) return alert("è«‹å…ˆå»ºç«‹é€£ç·š");
            const message = new Paho.MQTT.Message(msg);
            message.destinationName = document.getElementById('pub_topic').value;
            message.qos = parseInt(document.getElementById('pub_qos').value);
            message.retained = document.getElementById('pub_retain').checked;
            mqtt.send(message);
            addLog(`ğŸ“¤ ç™¼é€æŒ‡ä»¤: ${msg}`);
        }

        function sendMode() {
            const val = document.getElementById('mode_select').value;
            publishMsg(val);
        }

        function sendPeriods() {
            const val = document.getElementById('periods_text').value.trim();
            if (val) publishMsg(val);
            else alert("æ™‚æ®µå…§å®¹ä¸èƒ½ç‚ºç©º");
        }

        window.onload = () => {
            load();
            saveKeys.forEach(k => {
                document.getElementById(k).addEventListener('change', save);
                document.getElementById(k).addEventListener('input', save);
            });
        };
    </script>
</body>
</html>
